---
title: "Carbon Dioxide Avoidance"
author: "Jackie Culotta"
date: "2022-10-04"
output:
  html_document:
    df_print: paged
---

This Rmd file predicts dissolved CO~2~ (ppm) from instantaneous pH from water samples taken during avoidance trials.
Thresholds for dissolved CO~2~ avoidance are estimated from pH using the resulting model.

```{r setup 1, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
getwd()
```

# pH Trends in Tank

```{r CO2 map}
source("./LargeTank_CO2_Trend/CO2_Map.R")
pH_Trend_Both_Chambers
```

\
**Fig 1. The pH trend in both chambers.** The two chambers experienced relatively little water exchange across the connecting channel due to the circular chamber design and opposing currents.
However, water mixed uniformly within each chamber, as evidenced by similar pH values in the center of the chamber, immediately next to the exit, and at the gas stone.

```{r export CO2 map, eval=FALSE, include=FALSE}
ggsave(file = "C:/Users/jacki/OneDrive/Documents (Onedrive)/Thesis/Analysis/R_Statistics/Figures/EPS/Fig1_pH_Trend_Both_Chambers.eps",
       dpi = 300, width = 5, height = 5, units = "in", limitsize = TRUE)
pH_Trend_Both_Chambers
dev.off()

tiff("C:/Users/jacki/OneDrive/Documents (Onedrive)/Thesis/Analysis/R_Statistics/Figures/TIF/Fig1_pH_Trend_Both_Chambers.tif", width = 2100, height = 1200, units = "px", res = 300, compression = c("none"))
 pH_Trend_Both_Chambers
dev.off()
```

# CO2 avoidance

```{r load libraries, echo=FALSE, message=FALSE, warning=FALSE}
library('ggplot2')
library('ggpubr')
library('dplyr')
library('ggpmisc')
library('sjPlot')
library('knitr')
library('gdata') # keep function

keep(pH_Trend_Both_Chambers, sure = TRUE)

setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
# getwd()
```

## Large Tank

Create the figure for the model that predicts pCO2 (ppm) from pH.

```{r pH to ppm curve}
curve <- read.csv("allFish_pH_CO2_curve.csv") # All samples relating pH to pCO2 (ppm)

# Create pH to CO2 ppm curve
Model_to_predict_pCO2_from_pH <- ggplot(curve, aes(x = pH, y = ppm)) +
  geom_point(size = 3) +
  stat_poly_line(formula = y ~ poly(x,2,raw=TRUE),
                 size = 2,se = FALSE,color = 'black') +
  stat_poly_eq(label.x = 5.0, formula = y ~ poly(x, 2, raw = TRUE),
               aes(label = paste(after_stat(eq.label),
                   after_stat(rr.label), sep = "*\", \"*"))) +
  scale_y_continuous(name = expression('pCO'[2]*' (ppm)')) +
  scale_x_continuous(name = "pH", breaks = seq(6,8.5,0.5)) + 
  theme_classic2()
Model_to_predict_pCO2_from_pH
```

\
**Fig 2. Model to predict pCO2 from pH.** The relationship between pH and dissolved carbon dioxide in the large tank.
Water samples were collected from the increasing pCO~2~ chamber after first exit and three minutes after the last exit at the end of the trial.
Avoidance thresholds for dissolved carbon dioxide were predicted from the instantaneous pH value using this model.\

```{r export CO2 curve figure, include=FALSE, eval=FALSE}
ggsave(file = "C:/Users/jacki/OneDrive/Documents (Onedrive)/Thesis/Analysis/R_Statistics/Figures/EPS/Fig2_Model_to_predict_pCO2_from_pH.eps",
       dpi = 300, width = 5, height = 5, units = "in", limitsize = TRUE)
Model_to_predict_pCO2_from_pH
dev.off()

tiff("C:/Users/jacki/OneDrive/Documents (Onedrive)/Thesis/Analysis/R_Statistics/Figures/TIF/Fig2_Model_to_predict_pCO2_from_pH.tif", width = 2100, height = 1200, units = "px", res = 300, compression = c("none"))
Model_to_predict_pCO2_from_pH
dev.off()
```

Use the model to predict the pCO2 (ppm) that carp avoided, based on pH values.

```{r pH to ppm model}
Exp1 <- read.csv("Exp1_LargeTank_CO2_Avoidance.csv") # Avoidance thresholds from last tank

# Calculate 2nd order equation
fit2 <- lm(ppm~poly(pH,2,raw=TRUE), data = curve)
summary(fit2) # The figure above rounds coefficients in this equation

# Predict CO2 ppm at last avoidance pH
Exp1$pH <- Exp1$Last_Avoid_pH
Exp1$Last_Avoid_Estimated_CO2_ppm <- predict(fit2,newdata = Exp1)

# summarize results in large tank
Exp1_Results <- Exp1 %>% 
  filter_at(vars(X1st_Avoid_Measured_CO2_ppm, End_Trial_Measured_CO2_ppm), all_vars(!is.na(.))) %>% 
  group_by(Species) %>% 
  summarize(
  # FirstAvoid_Measured_ppm = mean(X1st_Avoid_Measured_CO2_ppm),
  # FirstAvoid_SE = sd(X1st_Avoid_Measured_CO2_ppm)/sqrt(length(X1st_Avoid_Measured_CO2_ppm)),
  Alk = mean(Alkalinity_ppm),
  Alk_SE = sd(Alkalinity_ppm)/sqrt(length(Alkalinity_ppm)),
  Temp = mean(Temp_C),
  Temp_SE = sd(Temp_C)/sqrt(length(Temp_C)),
   LastAvoid_Calculated = mean(Last_Avoid_Estimated_CO2_ppm, na.rm = TRUE),
   LastAvoid_SE = sd(Last_Avoid_Estimated_CO2_ppm)/sqrt(length(Last_Avoid_Estimated_CO2_ppm)),
   Measured = mean(End_Trial_Measured_CO2_ppm),
   Measured_SE = sd(End_Trial_Measured_CO2_ppm)/sqrt(length(End_Trial_Measured_CO2_ppm))
  )
Exp1_Results
```

```{r export model summary as table, eval=FALSE, include=FALSE}
# Format table to share values from 2nd order equation
library('stargazer')
stargazer(fit2,
         type = "html",
         out = "C:/Users/jacki/OneDrive/Documents (Onedrive)/Thesis/Analysis/R_Statistics/Figures/Supplement/pH to CO2 Model Table.doc")
```

## Small Tank

Water parameters were different in the small tank compared to the large, so the same model cannot be used.
Instead, CO2Calc software was used to predict pCO~2~ from pH, temp, and TA.
Those results are summarized here.

```{r small tank data}
SmallExp1 <- read.csv("Exp1_SmallTank_CO2_Avoidance.csv")
SmallExp1$Temp_C <- as.numeric(SmallExp1$Temp_C)

# summarize results in small tank
SmallExp1_Results <- SmallExp1 %>% 
#  group_by(Species) %>% # not a high enough N for each species
  summarize(
    Alk = mean(Alkalinity_Pre),
    Alk_SE = sd(Alkalinity_Pre)/sqrt(length(Alkalinity_Pre)),
    Temp = mean(Temp_C),
    Temp_SE = sd(Temp_C)/sqrt(length(Temp_C)), # unclear why this returns NA
    LastAvoid_Calculated = mean(CO2_Output_uAtm),
    LastAvoid_SE = sd(CO2_Output_uAtm)/sqrt(length(CO2_Output_uAtm)),
    Measured = mean(measured_pCO2_ppm, na.rm = TRUE),
    Measured_SE = sd(measured_pCO2_ppm, na.rm = TRUE)/sqrt(5)
  )
SmallExp1_Results
```

# Avoidance Thresholds

Generate the table with water parameters, measured, and predicted pCO~2~ values at last exit from the increasing pCO~2~ chamber.

**Table 2. Dissolved carbon dioxide avoidance and ambient water parameters.** The pCO~2~ is estimated from instantaneous pH at the last exit and measured from water samples taken three minutes afterwards.

```{r create co2 avoidance table}
# CO2 Avoidance Table
SmallExp1_Results$Species <- c("Bigheaded") # Bigheaded refers to both silver and bighead carps
SmallExp1_Results$Tank <- c("Small")
Exp1_Results$Tank <- c("Large")
BothExp1_Results <- full_join(SmallExp1_Results, Exp1_Results) # merge small and large tank results
BothExp1_Results <- select(BothExp1_Results, Tank, Species, everything()) # rearrange columns
kable(BothExp1_Results, 
      caption = "Carbon dioxide avoidance in both tanks",
      digits = 1)
```

```{r pull avoidance thresholds for in-text render, include=FALSE}
attach(Exp1_Results)
# Calculate average avoidance threshold for all data
avoidAvgBoth <- round(mean(BothExp1_Results$LastAvoid_Calculated))

# large tank
avoidBighead <- BothExp1_Results %>%  filter(Species == 'Bighead') %>%  select(LastAvoid_Calculated)
avoidSilver <- BothExp1_Results %>%  filter(Species == 'Silver') %>%  select(LastAvoid_Calculated)
avoidAvgLarge <- (avoidBighead + avoidSilver)/2
measureAvgLarge <- round(mean(Exp1_Results$Measured))

detach(Exp1_Results)
```

```{r export table for publication, include=FALSE, eval=FALSE}
labels <- c("Tank", "Species", "TA (ppm)", "SE", "Temp (°C)", "SE","Estimated (ppm)","SE","Measured (ppm)","SE")
tab_df(BothExp1_Results,
       title = "Dissolved carbon dioxide avoidance and ambient water parameters",
       col.header = labels,
       footnote = "text",
       show.footnote = FALSE,
       encoding = "Windows-1252",
       digits = 1,
       file = "./Figures/CO2_Avoidance_Table.doc"
    #   file = "C:/Users/jacki/OneDrive/Documents (Onedrive)/Thesis/Analysis/R_Statistics/Figures/CO2 Avoidance Table.doc"
    #  user.viewer = TRUE
)
```

## CO~2~ avoidance figure (boxplots)

```{r Boxplot Figure, message=FALSE, warning=FALSE}
SmallExp1$Tank <- c("Small")
Exp1$Tank <- c("Large")

# Alternative way to group small tank across species
# SmallExp1$Species <- gsub("Silver", "Bigheaded", fixed = TRUE, SmallExp1$Species)
# SmallExp1$Species <- gsub("Bighead", "Bigheaded", SmallExp1$Species)

BothExp1 <- full_join(Exp1, SmallExp1) %>% 
  mutate(Avoid = coalesce(Last_Avoid_Estimated_CO2_ppm,CO2_Output_uAtm))  %>% 
  select(Species,Avoid,Tank)

CO2_Avoidance_Boxplots <-  ggplot(BothExp1, aes(x = Tank, y = Avoid)) +
  stat_compare_means(label.x = 1.4) +
  geom_boxplot(position = position_dodge(1)) +
  geom_dotplot(binaxis = 'y',           # add dots
               stackdir = 'center',
               position = position_dodge(.15),
               aes(fill = Species)) + 
  labs(x = "Tank Size", 
       y = expression("pCO"[2]*" (ppm) at Last Exit")) +
  theme_classic2() + scale_fill_grey()
CO2_Avoidance_Boxplots
```

```{r export boxplot fig, include=FALSE, eval=FALSE}
tiff("./Figures/TIF/Fig5_CO2_Avoidance_Boxplots.tif", width = 1800, height = 1200, units = "px", res = 300, compression = c("none"))
CO2_Avoidance_Boxplots
dev.off()

ggsave(file = "./Figures/EPS/Fig5_CO2_Avoidance_Boxplots.eps",
       dpi = 300, width = 6, height = 5, units = "in", limitsize = TRUE)
CO2_Avoidance_Boxplots
dev.off()

```

## pH Avoidance Thresholds

Calculate the pH at the avoidance threshold using the reverse equation from before: now ppm to pH

```{r Avoidance Thresholds}
fit <- lm(pH~poly(ppm,2,raw=TRUE), data = curve)

pH <- as.numeric(c("NA"))
ppm <- as.numeric(c(avoidAvgBoth))
threshold <- data.frame(pH, ppm)

threshold$pH <- predict(fit, newdata = threshold)
threshold$avoidAvgRound <- round(avoidAvgBoth, digits = 1)
threshold
```

```{r figure and kruscal test}
mod <- kruskal.test(Avoid ~ Species, data = BothExp1)
mod
```

```{r formating variables, include = FALSE}
# paragraph one: both tanks
chi2 <- format(round(as.numeric(mod$statistic), 2), nsmall = 2, big.mark = ",")
pval <- format(round(as.numeric(mod$p.value), 2), nsmall = 2)
avoidPPM <- format(signif(as.numeric(avoidAvgBoth), 3), big.mark = ".", width = 3)
avoidPPM <- substr(avoidPPM, 1, 4)

pHThreshold <- format(round(as.numeric(threshold$pH), 2), nsmall = 2, big.mark = ",")

# paragraph two 
smallCO2 <- format(round(as.numeric(BothExp1_Results %>% filter(Species == 'Bigheaded') %>% select(LastAvoid_Calculated)), 1), nsmall = 1, big.mark = ",")
smallCO2_SE <- format(round(as.numeric(BothExp1_Results %>% filter(Species == 'Bigheaded') %>% select(LastAvoid_SE)), 1), nsmall = 1, big.mark = ",")
smallMeasured <- format(round(as.numeric(BothExp1_Results %>% filter(Species == 'Bigheaded') %>% select(Measured)), 1), nsmall = 1, big.mark = ",")
smallMeasured_SE <- format(round(as.numeric(BothExp1_Results %>% filter(Species == 'Bigheaded') %>% select(Measured_SE)), 1), nsmall = 1, big.mark = ",")

# paragraph three
largeBighead <- format(round(as.numeric(BothExp1_Results %>%  filter(Species == 'Bighead') %>% select(LastAvoid_Calculated)), 1), nsmall = 1, big.mark = ",")
largeBighead_SE <- format(round(as.numeric(BothExp1_Results %>%  filter(Species == 'Bighead') %>% select(LastAvoid_SE)), 1), nsmall = 1, big.mark = ",")
largeSilver <- format(round(as.numeric(BothExp1_Results %>%  filter(Species == 'Silver') %>% select(LastAvoid_Calculated)), 1), nsmall = 1, big.mark = ",")
largeSilver_SE <- format(round(as.numeric(BothExp1_Results %>%  filter(Species == 'Silver') %>% select(LastAvoid_SE)), 1), nsmall = 1, big.mark = ",")
largeBoth <- format(round(as.numeric(avoidAvgLarge), 1), nsmall = 1, big.mark = ",")
largeMeasured <- format(round(as.numeric(measureAvgLarge), 1), nsmall = 1, big.mark = ",")

largeMeasured_SE <- sd(Exp1$End_Trial_Measured_CO2_ppm, na.rm = TRUE)/sqrt(length(Exp1$End_Trial_Measured_CO2_ppm))
largeMeasured_SE <- format(round(as.numeric(largeMeasured_SE), 1), nsmall = 1, big.mark = ",")
largeMeasured_N <- as.numeric(length(Exp1$End_Trial_Measured_CO2_ppm))
```

# Results

## CO~2~ Avoidance Threshold

There was not a significant difference in dissolved CO~2~ avoidance thresholds between species or tank size (`r mod$method`, Χ^2^ = `r chi2`, p = `r pval`, Fig 5).
Across all trials in both tanks, bigheaded carp avoided pCO~2~ at approximately `r avoidPPM` K ppm.
This threshold pCO~2~ level was for CO~2~ conditioning treatments, with an instantaneous pH of approximately `r pHThreshold` by the conditioning treatment midpoint in the small tank, and endpoint in the large tank.
Due to tank volume differences, it was possible to reach this threshold within two minutes in the small tank, and approximately 10 minutes in the large tank, when addition was stopped for researcher safety.

```{r graph, echo=FALSE, message=FALSE}
CO2_Avoidance_Boxplots
```

\
**Fig 5. CO~2~ avoidance boxplots.** Bighead and silver carp exited the increasing pCO~2~ chamber for the last time at the same threshold level in the small and large tanks (`r mod$method`, Χ^2^ = `r chi2`, p = `r pval`).
Carp avoided pCO~2~ at `r avoidPPM` K ppm.\

Avoidance was defined as the last time the individual or the majority of the school (3 or more fish) exited the CO~2~ chamber.
In the small shuttle tank, schools of five juvenile untrained bighead (n = 5) and silver (n = 5) carp exhibited CO~2~ avoidance at `r smallCO2` ± `r smallCO2_SE` ppm (n = 10, mean ± SE, Table 2) as estimated by pH, TA, and temperature in CO2Calc.
As a secondary measurement of pCO~2~ from water samples by NDIR probe, avoidance occurred at `r smallMeasured` ± `r smallMeasured_SE` ppm (n = 6).
In the large shuttle tank, individual bighead carp (n = 10) exhibited their last CO~2~ avoidance at `r largeBighead` ± `r largeBighead_SE` ppm (Table 2).
Schools of five silver carp (n = 9) last exited the increasing chamber at `r largeSilver` ± `r largeSilver_SE` ppm.
In the large tank, the last avoidance occurred at `r largeBoth` ppm CO~2~ on average for both species, as estimated by pH (Fig 2).
The average pCO~2~ in the increasing chamber was measured at `r largeMeasured` ± `r largeMeasured_SE` ppm (n = `r largeMeasured_N`) three minutes after the last avoidance.
